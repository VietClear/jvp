<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>John’s Vietnamese Phrases</title>
    <!-- Handwritten title font (English title only) -->
    <link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet">
    <style>
        :root {
            --fg: #111;
            --bg: #fff;
            --muted: #666;
            --accent: #0b7a70;
            /* higher contrast teal */
            --accent-hover: #096f66;
            /* hover */
            --accent-press: #085f58;
            /* active */
            --card: #f7f7f7;
            --border: #e5e5e5;
            --pressed: #e9f4f3;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0;
            padding: 0
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--fg);
            background: var(--bg);
            line-height: 1.45;
        }

        .app-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 8px 12px;
        }

        .app-title {
            font-family: 'Handlee', cursive;
            font-size: 22px;
            margin: 0;
            text-align: center;
        }

        .top-nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding-top: 4px;
        }

        .tone-link {
            font-size: 14px;
            color: var(--accent);
            text-decoration: none;
        }

        .tone-link:hover {
            text-decoration: underline;
        }

        main#app {
            max-width: 960px;
            margin: 0 auto;
            padding: 12px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .view-header {
            display: flex;
            justify-content: center;
            padding: 8px 0 12px;
            position: sticky;
            top: 56px;
            background: var(--bg);
            z-index: 15;
            border-bottom: 1px solid var(--border);
        }

        .btn {
            border: 1px solid var(--border);
            background: var(--card);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color .12s ease, filter .12s ease, transform .08s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover {
            filter: brightness(.98)
        }

        .btn:active {
            background: var(--pressed);
        }

        .btn.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .btn.primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn.primary:active {
            background: var(--accent-press);
            border-color: var(--accent-press);
        }

        .btn.back {
            min-width: 180px;
            /* bigger touch target */
            font-weight: 700;
            /* clearer affordance */
            padding: 12px 16px;
            /* iPhone Safari friendly */
            border-radius: 14px;
        }

        .btn.ghost {
            background: transparent;
        }

        .btn.is-pressed,
        .audio-btn.is-pressed {
            transform: scale(0.98);
            box-shadow: 0 0 0 2px var(--pressed) inset;
        }

        .btn:focus-visible,
        .audio-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(11, 122, 112, 0.25);
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: 12px;
        }

        .category-list li {
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 14px;
            padding: 16px;
            cursor: pointer;
            transition: filter .12s ease;
        }

        .category-list li:hover {
            filter: brightness(.98)
        }

        .category-list li:active {
            background: var(--pressed);
        }

        .category-name {
            display: block;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .category-count {
            color: var(--muted);
            font-size: 13px;
        }

        .category-title {
            text-align: center;
            margin: 14px 0;
            font-size: 18px;
        }

        .phrases-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .phrase-card {
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: 14px;
            padding: 12px;
        }

        .phrase-top {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .audio-btn {
            display: inline-block;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color .12s ease, filter .12s ease, transform .08s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .audio-btn:hover {
            filter: brightness(.98)
        }

        .audio-btn:active {
            background: var(--pressed);
        }

        .audio-btn.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .audio-btn.primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .audio-btn.primary:active {
            background: var(--accent-press);
            border-color: var(--accent-press);
        }

        .audio-btn[aria-busy="true"] {
            opacity: .7;
            pointer-events: none;
        }

        /* Colour feedback while playing */
        .audio-btn.playing {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .syllable-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .syllable {
            border: 1px dashed var(--border);
            border-radius: 10px;
            padding: 8px;
            display: grid;
            grid-template-rows: auto auto auto;
            gap: 4px;
        }

        .syllable .syllable-text {
            font-size: 18px;
            font-weight: 700;
        }

        .syllable .tone-name {
            font-size: 12px;
            color: var(--muted);
        }

        .translation {
            margin-top: 4px;
            color: var(--muted);
            font-size: 14px;
            font-style: italic;
            /* clearer separation from Vietnamese */
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .note {
            color: var(--muted);
            font-size: 13px;
        }

        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
            border: 0;
            padding: 0;
            margin: -1px;
        }

        @media (max-width:480px) {
            .syllable-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>

<body>
    <header class="app-header">
        <h1 class="app-title">John’s Vietnamese Phrases</h1>
        <nav class="top-nav">
            <a href="#tone-guide" id="toneGuideLink" class="tone-link">Tone Guide</a>
        </nav>
    </header>

    <main id="app">
        <!-- View: Categories (DEFAULT) -->
        <section id="view-categories" class="view active" aria-label="Categories">
            <h2 class="visually-hidden">Categories</h2>
            <ul id="categoryList" class="category-list"></ul>
        </section>

        <!-- View: Phrases -->
        <section id="view-phrases" class="view" aria-label="Phrases" hidden>
            <div class="view-header">
                <button id="btnBackToCategories" class="btn back">Categories</button>
            </div>
            <h2 id="phrasesCategoryTitle" class="category-title"></h2>
            <div id="phrasesContainer" class="phrases-container"></div>
        </section>

        <!-- View: Tone Guide -->
        <section id="view-tone" class="view" aria-label="Tone Guide" hidden>
            <div class="view-header">
                <button id="btnBackFromTone" class="btn back">Categories</button>
            </div>
            <h2 class="category-title">Tone Guide</h2>
            <div class="tone-guide">
                <ul>
                    <li><strong>sắc</strong> — rising ↗</li>
                    <li><strong>huyền</strong> — falling ↘</li>
                    <li><strong>hỏi</strong> — dipping ˇ</li>
                    <li><strong>nặng</strong> — heavy/low (glottal stop)</li>
                    <li><strong>không</strong> — level (no mark)</li>
                </ul>
                <p class="note">Micro-audio/visuals can be added later without changing layout.</p>
            </div>
        </section>
    </main>

    <script>
        // =========================
        // ID-based mapping (no slugifying)
        // =========================

        /** Global mapping loaded from /assets/mapping.json */
        let MAPPING = null; // { categories:[{id,name}], phrases:{ [catId]: [{ id, vi, en, syllables:[{ id, text, tone }] }] } }

        async function initMapping() {
            try {
                const res = await fetch('/assets/mapping.json', { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                MAPPING = await res.json();
            } catch (err) {
                console.error('Failed to load mapping.json', err);
                MAPPING = { categories: [], phrases: {} };
            }
        }

        // Simple player with visual feedback.
        let CURRENT_AUDIO = null;
        let CURRENT_BTN = null;

        function stopCurrentAudio() {
            if (CURRENT_AUDIO) {
                try { CURRENT_AUDIO.pause(); CURRENT_AUDIO.currentTime = 0; } catch { }
                CURRENT_AUDIO = null;
            }
            if (CURRENT_BTN) {
                CURRENT_BTN.classList.remove('playing');
                CURRENT_BTN.removeAttribute('aria-busy');
                CURRENT_BTN = null;
            }
        }

        function playById(id, btn) {
            try {
                stopCurrentAudio();

                const audio = new Audio(`assets/audio/${id}.mp3`);
                CURRENT_AUDIO = audio;
                CURRENT_BTN = btn || null;

                if (CURRENT_BTN) {
                    CURRENT_BTN.classList.add('playing');
                    CURRENT_BTN.setAttribute('aria-busy', 'true');
                }

                audio.addEventListener('ended', stopCurrentAudio, { once: true });
                audio.addEventListener('error', stopCurrentAudio, { once: true });

                audio.play();
            } catch (e) {
                console.warn('Audio failed for id:', id, e);
                stopCurrentAudio();
            }
        }

        // =========================
        // Record & Compare (phrase-level, temporary)
        // =========================
        // In-memory map of phraseId -> { url, blob }
        const RECORDINGS = new Map();
        let ACTIVE_RECORD = null; // { phraseId, mediaRecorder, chunks, btnRecord, btnPlay }

        async function getUserMediaStream() {
            return navigator.mediaDevices?.getUserMedia
                ? navigator.mediaDevices.getUserMedia({ audio: true })
                : Promise.reject(new Error('getUserMedia not supported'));
        }

        async function startRecording(phraseId, btnRecord, btnPlay) {
            if (ACTIVE_RECORD) await stopRecording(); // ensure only one at a time

            let stream;
            try {
                stream = await getUserMediaStream();
            } catch (e) {
                alert('Microphone permission is needed for recording.');
                return;
            }

            const chunks = [];
            const mr = new MediaRecorder(stream);
            ACTIVE_RECORD = { phraseId, mediaRecorder: mr, chunks, btnRecord, btnPlay };

            btnRecord.textContent = 'Stop';
            btnRecord.classList.add('primary');
            btnRecord.setAttribute('aria-busy', 'true');

            mr.addEventListener('dataavailable', e => { if (e.data && e.data.size) chunks.push(e.data); });
            mr.addEventListener('stop', () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                // Revoke old URL if exists
                const prev = RECORDINGS.get(phraseId);
                if (prev?.url) { try { URL.revokeObjectURL(prev.url); } catch { } }

                const url = URL.createObjectURL(blob);
                RECORDINGS.set(phraseId, { url, blob });

                btnPlay.disabled = false;
                btnRecord.textContent = 'Record';
                btnRecord.classList.remove('primary');
                btnRecord.removeAttribute('aria-busy');

                // stop tracks
                stream.getTracks().forEach(t => t.stop());
                ACTIVE_RECORD = null;
            });

            mr.start();
        }

        async function stopRecording() {
            if (!ACTIVE_RECORD) return;
            try {
                ACTIVE_RECORD.mediaRecorder.stop();
            } catch { }
        }

        function playMyRecording(phraseId, btn) {
            const rec = RECORDINGS.get(phraseId);
            if (!rec?.url) return;

            stopCurrentAudio();
            const audio = new Audio(rec.url);
            CURRENT_AUDIO = audio;
            CURRENT_BTN = btn || null;

            if (CURRENT_BTN) {
                CURRENT_BTN.classList.add('playing');
                CURRENT_BTN.setAttribute('aria-busy', 'true');
            }

            audio.addEventListener('ended', stopCurrentAudio, { once: true });
            audio.addEventListener('error', stopCurrentAudio, { once: true });

            audio.play();
        }

        // =========================
        // Views / Rendering
        // =========================
        const $ = sel => document.querySelector(sel);

        function showView(name) {
            const views = ["categories", "phrases", "tone"];
            views.forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (!el) return;
                const on = (v === name);
                el.hidden = !on;
                el.classList.toggle('active', on);
            });
            if (name === "categories") { window.scrollTo({ top: 0, behavior: 'instant' }); }
        }

        function renderCategories() {
            const ul = $("#categoryList");
            ul.innerHTML = "";
            (MAPPING.categories || []).forEach(cat => {
                const count = (MAPPING.phrases?.[cat.id] || []).length;
                const li = document.createElement('li');
                li.innerHTML = `<span class="category-name">${cat.name}</span>
                        <span class="category-count">${count} phrase${count === 1 ? "" : "s"}</span>`;
                li.addEventListener('click', () => openCategory(cat.id, cat.name));
                ul.appendChild(li);
            });
        }

        function openCategory(catId, catName) {
            $("#phrasesCategoryTitle").textContent = catName;
            const container = $("#phrasesContainer");
            container.innerHTML = "";

            const items = MAPPING.phrases?.[catId] || [];
            items.forEach(item => {
                // item: { id: '00001', vi, en, syllables:[{ id:'00037', text, tone }] }
                const card = document.createElement('div');
                card.className = 'phrase-card';

                // Top row: phrase play + text
                const top = document.createElement('div');
                top.className = 'phrase-top';

                const btnPhrase = document.createElement('button');
                btnPhrase.className = 'audio-btn primary';
                btnPhrase.textContent = "▶︎";
                btnPhrase.setAttribute('data-id', item.id);
                btnPhrase.addEventListener('click', () => playById(item.id, btnPhrase));

                const phraseText = document.createElement('div');
                phraseText.innerHTML = `<strong>${item.vi}</strong>`;

                top.appendChild(btnPhrase);
                top.appendChild(phraseText);

                // Translation (moved directly under phrase text for clearer reading order)
                const tr = document.createElement('div');
                tr.className = 'translation';
                tr.textContent = item.en;

                // Syllables row
                const row = document.createElement('div');
                row.className = 'syllable-row';
                (item.syllables || []).forEach(syl => {
                    const wrap = document.createElement('div');
                    wrap.className = 'syllable';

                    const btnSyl = document.createElement('button');
                    btnSyl.className = 'audio-btn';
                    btnSyl.textContent = "▶︎";
                    btnSyl.setAttribute('data-id', syl.id);
                    btnSyl.addEventListener('click', () => playById(syl.id, btnSyl));

                    const sylText = document.createElement('div');
                    sylText.className = 'syllable-text';
                    sylText.textContent = syl.text;

                    const tone = document.createElement('div');
                    tone.className = 'tone-name';
                    tone.textContent = syl.tone;

                    wrap.appendChild(btnSyl);
                    wrap.appendChild(sylText);
                    wrap.appendChild(tone);
                    row.appendChild(wrap);
                });

                // Controls — Record & Compare (phrase-level)
                const controls = document.createElement('div');
                controls.className = 'controls';

                const btnRecord = document.createElement('button');
                btnRecord.className = 'btn';
                btnRecord.textContent = 'Record';
                btnRecord.title = 'Record your attempt (temporary, not saved)';

                const btnMy = document.createElement('button');
                btnMy.className = 'btn';
                btnMy.textContent = 'Play My Recording';
                btnMy.title = 'Toggle to your last recording for this phrase';
                btnMy.disabled = !RECORDINGS.get(item.id);

                // Record toggle behavior
                btnRecord.addEventListener('click', async () => {
                    // If currently recording this phrase, stop. Else start.
                    if (ACTIVE_RECORD && ACTIVE_RECORD.phraseId === item.id) {
                        await stopRecording();
                    } else {
                        // If recording another phrase, stop it first
                        if (ACTIVE_RECORD) await stopRecording();
                        startRecording(item.id, btnRecord, btnMy);
                    }
                });

                // Play recorded attempt (if available)
                btnMy.addEventListener('click', () => playMyRecording(item.id, btnMy));

                controls.append(btnRecord, btnMy);

                // Assemble card
                card.appendChild(top);
                card.appendChild(tr);
                card.appendChild(row);
                card.appendChild(controls);

                container.appendChild(card);
            });

            // After rendering a new list, reattach press feedback handlers
            attachPressFeedback(container);

            showView('phrases');
        }

        // ——— Press feedback helper ———
        function attachPressFeedback(root = document) {
            const pressables = root.querySelectorAll('.btn, .audio-btn');
            pressables.forEach(el => {
                const onDown = () => el.classList.add('is-pressed');
                const onUp = () => el.classList.remove('is-pressed');

                el.addEventListener('mousedown', onDown);
                el.addEventListener('mouseup', onUp);
                el.addEventListener('mouseleave', onUp);

                el.addEventListener('touchstart', onDown, { passive: true });
                el.addEventListener('touchend', onUp, { passive: true });
                el.addEventListener('touchcancel', onUp, { passive: true });
            });
        }

        // ——— Wiring: nav + init ———
        document.getElementById('toneGuideLink').addEventListener('click', (e) => { e.preventDefault(); showView('tone'); });
        document.getElementById('btnBackToCategories').addEventListener('click', () => showView('categories'));
        document.getElementById('btnBackFromTone').addEventListener('click', () => showView('categories'));

        // Boot
        (async function start() {
            await initMapping();
            renderCategories();
            attachPressFeedback(document);
            showView('categories'); // categories-first
        })();
    </script>
</body>

</html>