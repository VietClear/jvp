<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>John’s Vietnamese Phrases (JVP)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <style>
        :root {
            --bg: #0b0c0f;
            --panel: #11141a;
            --muted: #8b93a7;
            --text: #e8ecf2;
            --accent: #27c3a6;
            --accent2: #ffb74a;
            --danger: #ff6b6b;
            --border: #1f2634;
            --card: #0e1218;
            --shadow: rgba(0, 0, 0, .35)
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial
        }

        a {
            color: inherit;
            text-decoration: none
        }

        button {
            appearance: none;
            border: 1px solid var(--border);
            background: #121826;
            color: var(--text);
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: .15s border-color, .15s background, .02s transform
        }

        button:hover {
            border-color: #2a3245
        }

        button:active {
            transform: translateY(1px)
        }

        button[disabled] {
            opacity: .6;
            cursor: not-allowed
        }

        .primary {
            background: #0f1918;
            border-color: #1d3a37
        }

        .warn {
            background: #191314;
            border-color: #3a1d1f
        }

        .ghost {
            background: #0f141d
        }

        .linklike {
            background: transparent;
            border-color: transparent;
            padding: 8px 10px;
            opacity: .9
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border);
            background: #0e1117;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px
        }

        .app {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh
        }

        .topbar {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            background: #0d1117;
            position: sticky;
            top: 0;
            z-index: 3
        }

        .title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: .2px;
            margin: 0;
            display: flex;
            gap: 10px;
            align-items: center
        }

        .pill {
            font-size: 12px;
            color: var(--muted)
        }

        .container {
            height: 100%;
            overflow: auto
        }

        .screen {
            max-width: 1100px;
            margin: 0 auto;
            padding: 18px;
            display: none
        }

        .screen.active {
            display: block
        }

        .grid {
            display: grid;
            gap: 14px
        }

        .categories {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr))
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 16px;
            background: var(--card);
            box-shadow: 0 6px 18px var(--shadow);
            padding: 16px
        }

        .cat {
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer
        }

        .cat h3 {
            margin: 0 0 4px 0
        }

        .phrases {
            display: grid;
            gap: 16px
        }

        .phrase-card h2 {
            margin: 0 0 4px 0
        }

        .subtitle {
            margin: 0;
            color: var(--muted)
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px
        }

        .syllables {
            border-top: 1px dashed var(--border);
            margin-top: 12px;
            padding-top: 12px;
            display: grid;
            gap: 10px
        }

        .syll-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center
        }

        .syll-txt {
            font-size: 18px;
            font-weight: 700
        }

        .tone-chip {
            font-size: 12px;
            color: var(--muted)
        }

        .footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            color: var(--muted);
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        audio {
            width: 100%
        }

        @media (max-width:720px) {
            .syll-row {
                grid-template-columns: auto 1fr
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="topbar">
            <div class="title">
                <span
                    style="width:10px;height:10px;border-radius:50%;background:var(--accent);display:inline-block"></span>
                John’s Vietnamese Phrases
            </div>
            <div class="toolbar">
                <button id="btnCategories" class="linklike" title="Back to Categories" style="display:none">◀
                    Categories</button>
                <button id="btnToneGuide" class="linklike" title="Tone Guide">Tone Guide</button>
                <span class="pill" id="netStatus"></span>
            </div>
        </header>

        <main class="container">
            <!-- Screen: Categories -->
            <section id="screenCategories" class="screen active">
                <div class="grid categories" id="categoryGrid"></div>
            </section>

            <!-- Screen: Phrase List within a Category -->
            <section id="screenPhrases" class="screen">
                <div class="grid phrases" id="phrasesGrid"></div>
            </section>

            <!-- Screen: Tone Guide (no audio files required) -->
            <section id="screenGuide" class="screen">
                <div class="card">
                    <h2>Tone Guide (Southern Vietnamese)</h2>
                    <p class="subtitle">Names and rough pitch shapes.</p>
                    <ul id="toneList" style="margin:10px 0 0 18px;line-height:1.6"></ul>
                </div>
            </section>
        </main>

        <footer class="footer">
            <span id="status">Ready.</span>
            <span>Build: 2025-09-04 • BP2-complete subset (uses your exact filenames).</span>
        </footer>
    </div>
    <script>
        // Tones (labels only; no tone audio files required)
        const TONES = [
            { key: "khong", name: "không (level)", shape: "—" },
            { key: "sac", name: "sắc (high rising)", shape: "↗" },
            { key: "huyen", name: "huyền (low falling)", shape: "↘" },
            { key: "hoi", name: "hỏi (dipping)", shape: "∨" },
            { key: "nga", name: "ngã (creaky rising)", shape: "˷↗" },
            { key: "nang", name: "nặng (glottal low)", shape: "•" },
            { key: "loan", name: "loan/foreign", shape: "" }
        ];

        // Helper to build a syllable object with your exact audio filename
        const A = (file, text, tone) => ({ text, tone, audio: `assets/audio/${file}` });

        // CATEGORIES with phrases limited to the syllables you actually provided (fully playable)
        const CATS = [
            {
                id: "essentials", name: "Essentials",
                phrases: [
                    {
                        key: "xin-chao", vi: "Xin chào", en: "Hello",
                        syllables: [A("xin.mp3", "Xin", "sac"), A("chào.mp3", "chào", "huyen")]
                    },

                    {
                        key: "tam-biet", vi: "Tạm biệt", en: "Goodbye",
                        syllables: [A("tạm.mp3", "Tạm", "nang"), A("biệt.mp3", "biệt", "sac")]
                    },

                    {
                        key: "khoe-khong", vi: "Khỏe không?", en: "How are you?",
                        syllables: [A("khỏe.mp3", "Khỏe", "hoi"), A("không.mp3", "không", "khong")]
                    },

                    {
                        key: "toi-khoe", vi: "Tôi khỏe", en: "I’m fine",
                        syllables: [A("tôi.mp3", "Tôi", "khong"), A("khỏe.mp3", "khỏe", "hoi")]
                    },

                    {
                        key: "toi-chi-noi-duoc-mot-chut-tieng-viet",
                        vi: "Tôi chỉ nói được một chút tiếng Việt",
                        en: "I only speak a little Vietnamese",
                        syllables: [
                            A("tôi.mp3", "Tôi", "khong"),
                            A("chỉ.mp3", "chỉ", "hoi"),
                            A("nói.mp3", "nói", "sac"),
                            A("được.mp3", "được", "nang"),
                            A("một.mp3", "một", "nang"),
                            A("chút.mp3", "chút", "sac"),
                            A("tiếng.mp3", "tiếng", "sac"),
                            A("việt.mp3", "Việt", "nang")
                        ]
                    },

                    {
                        key: "khong-co-gi", vi: "Không có gì", en: "You’re welcome / no problem",
                        syllables: [A("không.mp3", "Không", "khong"), A("có.mp3", "có", "sac"), A("gì.mp3", "gì", "khong")]
                    },

                    {
                        key: "rat-vui-duoc-gap-ban", vi: "Rất vui được gặp bạn", en: "Nice to meet you",
                        syllables: [
                            A("rất.mp3", "Rất", "sac"),
                            A("vui.mp3", "vui", "khong"),
                            A("được.mp3", "được", "nang"),
                            A("gặp.mp3", "gặp", "nang"),
                            A("bạn.mp3", "bạn", "nang")
                        ]
                    },
                ]
            },
            {
                id: "food", name: "Food & Drink",
                phrases: [
                    {
                        key: "ca-phe-sua-da", vi: "Cà phê sữa đá", en: "Iced coffee with milk",
                        syllables: [A("cà.mp3", "Cà", "huyen"), A("phê.mp3", "phê", "khong"), A("sữa.mp3", "sữa", "sac"), A("đá.mp3", "đá", "sac")]
                    },

                    {
                        key: "nuoc-loc", vi: "Nước lọc", en: "Water",
                        syllables: [A("nước.mp3", "Nước", "sac"), A("lọc.mp3", "lọc", "nang")]
                    },

                    {
                        key: "to-pho", vi: "Tô phở", en: "A bowl of phở",
                        syllables: [A("tô.mp3", "Tô", "khong"), A("phở.mp3", "phở", "hoi")]
                    },

                    {
                        key: "ngon-qua", vi: "Ngon quá!", en: "So delicious!",
                        syllables: [A("ngon.mp3", "Ngon", "khong"), A("quá.mp3", "quá", "sac")]
                    },

                    {
                        key: "tinh-tien-oi", vi: "Tính tiền, ơi!", en: "The bill, please",
                        syllables: [A("tính.mp3", "Tính", "sac"), A("tiền.mp3", "tiền", "huyen"), A("ơi.mp3", "ơi", "khong")]
                    },
                ]
            },
            {
                id: "travel", name: "Travel",
                phrases: [
                    {
                        key: "di-dau-vay", vi: "Đi đâu vậy?", en: "Where are you going?",
                        syllables: [A("đi.mp3", "Đi", "khong"), A("đâu.mp3", "đâu", "khong"), A("vậy.mp3", "vậy", "nang")]
                    },

                    {
                        key: "qua-mac", vi: "Quá mắc!", en: "Too expensive!",
                        syllables: [A("quá.mp3", "Quá", "sac"), A("mắc.mp3", "mắc", "sac")]
                    },

                    {
                        key: "toi-muon-di-toi", vi: "Tôi muốn đi tới…", en: "I want to go to…",
                        syllables: [A("tôi.mp3", "Tôi", "khong"), A("muốn.mp3", "muốn", "sac"), A("đi.mp3", "đi", "khong"), A("tới.mp3", "tới", "sac")]
                    },
                ]
            },
            {
                id: "social", name: "Social",
                phrases: [
                    {
                        key: "ban-ten-gi", vi: "Bạn tên gì?", en: "What’s your name?",
                        syllables: [A("bạn.mp3", "Bạn", "nang"), A("tên.mp3", "tên", "khong"), A("gì.mp3", "gì", "huyen")]
                    },

                    {
                        key: "toi-ten-la-john", vi: "Tôi tên là John", en: "My name is John",
                        syllables: [A("tôi.mp3", "Tôi", "khong"), A("tên.mp3", "tên", "khong"), A("là.mp3", "là", "huyen"), A("john.mp3", "John", "loan")]
                    },

                    {
                        key: "toi-khong-hieu", vi: "Tôi không hiểu", en: "I don’t understand",
                        syllables: [A("tôi.mp3", "Tôi", "khong"), A("không.mp3", "không", "khong"), A("hiểu.mp3", "hiểu", "hoi")]
                    },

                    {
                        key: "khong-sao-dau", vi: "Không sao đâu", en: "It’s okay / no problem",
                        syllables: [A("không.mp3", "Không", "khong"), A("sao.mp3", "sao", "khong"), A("đâu.mp3", "đâu", "khong")]
                    },

                    {
                        key: "toi-nho-ban", vi: "Tôi nhớ bạn", en: "I miss you",
                        syllables: [A("tôi.mp3", "Tôi", "khong"), A("nhớ.mp3", "nhớ", "sac"), A("bạn.mp3", "bạn", "nang")]
                    },

                    {
                        key: "toi-thuong-ban", vi: "Tôi thương bạn", en: "I love you",
                        syllables: [A("tôi.mp3", "Tôi", "khong"), A("thương.mp3", "thương", "khong"), A("bạn.mp3", "bạn", "nang")]
                    },
                ]
            },
            {
                id: "shopping", name: "Shopping & Money",
                phrases: [
                    {
                        key: "giam-gia-duoc-khong", vi: "Giảm giá được không?", en: "Can you give a discount?",
                        syllables: [A("giảm.mp3", "Giảm", "hoi"), A("giá.mp3", "giá", "sac"), A("được.mp3", "được", "nang"), A("không.mp3", "không", "khong")]
                    },

                    {
                        key: "mac-qua", vi: "Mắc quá!", en: "Too expensive!",
                        syllables: [A("mắc.mp3", "Mắc", "sac"), A("quá.mp3", "quá", "sac")]
                    },

                    {
                        key: "co-size-lon-hon-khong", vi: "Có size lớn hơn không?", en: "Do you have a bigger size?",
                        syllables: [A("có.mp3", "Có", "sac"), A("size.mp3", "size", "loan"), A("lớn.mp3", "lớn", "sac"), A("hơn.mp3", "hơn", "khong"), A("không.mp3", "không", "khong")]
                    },
                ]
            }
        ];
        // ---------- DOM + RENDER ----------
        const els = {};
        const $ = s => document.querySelector(s);

        function initEls() {
            els.screenCategories = $("#screenCategories");
            els.screenPhrases = $("#screenPhrases");
            els.screenGuide = $("#screenGuide");
            els.categoryGrid = $("#categoryGrid");
            els.phrasesGrid = $("#phrasesGrid");
            els.btnCategories = $("#btnCategories");
            els.btnToneGuide = $("#btnToneGuide");
            els.status = $("#status");
            els.netStatus = $("#netStatus");
            els.toneList = $("#toneList");
        }

        function setScreen(name) {
            [els.screenCategories, els.screenPhrases, els.screenGuide].forEach(s => s.classList.remove("active"));
            if (name === "categories") { els.screenCategories.classList.add("active"); els.btnCategories.style.display = "none"; setStatus("Select a category."); }
            if (name === "phrases") { els.screenPhrases.classList.add("active"); els.btnCategories.style.display = "inline-block"; setStatus(""); }
            if (name === "guide") { els.screenGuide.classList.add("active"); els.btnCategories.style.display = "inline-block"; setStatus(""); }
        }

        function renderCategories() {
            els.categoryGrid.innerHTML = "";
            CATS.forEach(cat => {
                const div = document.createElement("div");
                div.className = "card cat";
                div.innerHTML = `<h3>${cat.name}</h3><p class="subtitle">${cat.phrases.length} phrases</p>`;
                div.addEventListener("click", () => openCategory(cat.id));
                els.categoryGrid.appendChild(div);
            });
        }

        function openCategory(catId) {
            const cat = CATS.find(c => c.id === catId);
            if (!cat) return;
            els.phrasesGrid.innerHTML = "";
            cat.phrases.forEach(p => els.phrasesGrid.appendChild(renderPhraseCard(p)));
            setScreen("phrases");
        }

        function renderPhraseCard(p) {
            const card = document.createElement("div");
            card.className = "card phrase-card";
            card.innerHTML = `
        <h2>${p.vi}</h2>
        <p class="subtitle">${p.en}</p>
        <div class="row">
          <button class="primary" data-role="play-phrase">▶︎ Play phrase</button>
          <button class="ghost" data-role="record" data-key="${p.key}">● Record</button>
          <button class="warn"  data-role="stop" data-key="${p.key}" disabled>■ Stop</button>
          <button class="ghost" data-role="play-user" data-key="${p.key}" disabled>▶︎ Play My Recording</button>
          <span class="badge" title="ToneChecker placeholder"><strong>Check Tone</strong> (coming soon)</span>
        </div>
        <div class="syllables">
          ${p.syllables.map(syl => `
            <div class="syll-row">
              <button class="primary" data-role="play-syll" data-audio="${syl.audio}">▶︎</button>
              <div class="syll-txt">${syl.text}</div>
              <div class="tone-chip">${toneName(syl.tone)}</div>
            </div>
          `).join("")}
        </div>
        <audio preload="none" controls playsinline style="margin-top:8px;display:none"></audio>
      `;

            // Bind: play full phrase (sequential syllables)
            const btnPlayPhrase = card.querySelector('[data-role="play-phrase"]');
            btnPlayPhrase.addEventListener("click", () => playPhraseSequence(p.syllables.map(s => s.audio), card));

            // Bind: play individual syllables
            card.querySelectorAll('[data-role="play-syll"]').forEach(b => {
                b.addEventListener("click", () => playSingle(b.getAttribute("data-audio"), card));
            });

            // Bind: record controls
            const btnRec = card.querySelector('[data-role="record"]');
            const btnStop = card.querySelector('[data-role="stop"]');
            const btnUser = card.querySelector('[data-role="play-user"]');
            btnRec.addEventListener("click", () => startRecording(p.key, btnRec, btnStop, btnUser));
            btnStop.addEventListener("click", () => stopIfRecording());
            btnUser.addEventListener("click", () => playUserRecording(p.key, card));

            return card;
        }

        function toneName(key) {
            if (key === "loan") return "loan/foreign";
            const t = TONES.find(t => t.key === key);
            return t ? t.name : key;
        }

        function renderToneGuide() {
            els.toneList.innerHTML = "";
            TONES.forEach(t => {
                const li = document.createElement("li");
                li.textContent = `${t.name} ${t.shape ? `— ${t.shape}` : ""}`;
                els.toneList.appendChild(li);
            });
        }
        // ---------- STATUS + NET ----------
        function setStatus(text, isWarn = false) {
            els.status.textContent = text || " ";
            els.status.style.color = isWarn ? "var(--danger)" : "var(--muted)";
        }
        function setupNetBadge() {
            const update = () => {
                const online = navigator.onLine;
                els.netStatus.textContent = online ? "Online" : "Offline";
                els.netStatus.style.color = online ? "var(--accent)" : "var(--danger)";
            };
            window.addEventListener("online", update);
            window.addEventListener("offline", update);
            update();
        }
        function enc(u) { try { return encodeURI(u) } catch { return u } }

        // ---------- PLAYBACK ----------
        function cardPlayer(card) {
            const a = card.querySelector("audio");
            a.style.display = "block";
            return a;
        }

        function playSingle(src, card) {
            const a = cardPlayer(card);
            a.onended = null;
            a.onerror = () => setStatus("Audio error. Check file path.", true);
            a.src = enc(src);
            a.currentTime = 0;
            a.play().catch(() => setStatus("Tap again to allow audio.", true));
        }

        // Sequential phrase playback (plays syllable files in order)
        let seqToken = 0;
        function playPhraseSequence(srcs, card) {
            const a = cardPlayer(card);
            const my = ++seqToken;
            let i = 0;
            const next = () => {
                if (my !== seqToken) return; // cancelled by a new sequence
                if (i >= srcs.length) { a.onended = null; return; }
                a.onerror = () => { setStatus("Audio error. Skipping item.", true); i++; next(); };
                a.src = enc(srcs[i++]);
                a.currentTime = 0;
                a.play().catch(() => setStatus("Tap again to allow audio.", true));
            };
            a.onended = next;
            next();
        }

        // ---------- RECORD / COMPARE (PHRASE LEVEL) ----------
        let activeStream = null, mediaRecorder = null, chunks = [], currentRecordingKey = null;
        const userObjectURLs = new Map(); // phraseKey -> blob URL

        function bestMime() {
            const list = ["audio/webm;codecs=opus", "audio/webm", "audio/ogg;codecs=opus", "audio/ogg"];
            for (const m of list) { if (MediaRecorder.isTypeSupported?.(m)) return m; }
            return "";
        }

        async function startRecording(phraseKey, btnRec, btnStop, btnUser) {
            try {
                activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(activeStream, { mimeType: bestMime() });
            } catch (err) {
                console.error("Mic init failed:", err);
                setStatus("Microphone not available / permission denied.", true);
                return;
            }
            chunks = []; currentRecordingKey = phraseKey;
            mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: mediaRecorder.mimeType || "audio/webm" });
                const old = userObjectURLs.get(phraseKey); if (old) URL.revokeObjectURL(old);
                const url = URL.createObjectURL(blob);
                userObjectURLs.set(phraseKey, url);
                btnUser.disabled = false;
                btnStop.disabled = true;
                btnRec.disabled = false;
                setStatus("Recording saved (temporary). You can play or re-record.");
                teardownStream();
            };
            mediaRecorder.start();
            btnRec.disabled = true; btnStop.disabled = false;
            setStatus("Recording… Speak now. Press Stop to finish.");
        }

        function stopIfRecording() {
            try {
                if (mediaRecorder && mediaRecorder.state !== "inactive") { mediaRecorder.stop(); }
                else { teardownStream(); }
            } catch { teardownStream(); }
        }

        function teardownStream() {
            if (activeStream) { try { activeStream.getTracks().forEach(t => t.stop()); } catch { } }
            activeStream = null; mediaRecorder = null; chunks = [];
        }

        function playUserRecording(phraseKey, card) {
            const url = userObjectURLs.get(phraseKey);
            if (!url) { setStatus("No recording yet for this phrase.", true); return; }
            const a = cardPlayer(card);
            a.onended = null;
            a.onerror = () => setStatus("Could not play your recording.", true);
            a.src = url;
            a.currentTime = 0;
            a.play().catch(() => setStatus("Tap again to allow audio.", true));
        }
        // ---------- NAV + INIT ----------
        function bindNav() {
            els.btnCategories.addEventListener("click", () => setScreen("categories"));
            els.btnToneGuide.addEventListener("click", () => {
                renderToneGuide();
                setScreen("guide");
            });
        }

        function init() {
            initEls();
            setupNetBadge();
            renderCategories();
            bindNav();
            setScreen("categories");
        }

        window.addEventListener("DOMContentLoaded", init);
    </script>
</body>

</html>