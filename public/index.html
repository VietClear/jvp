<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>John’s Vietnamese Phrases</title>
    <link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet">
    <style>
        :root {
            --fg: #111;
            --bg: #fff;
            --muted: #666;
            --accent: #0f766e;
            --card: #f7f7f7;
            --border: #e5e5e5;
            --pressed: #e9f4f3;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0;
            padding: 0
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--fg);
            background: var(--bg);
            line-height: 1.45;
        }

        .app-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 8px 12px;
        }

        .app-title {
            font-family: 'Handlee', cursive;
            font-size: 22px;
            margin: 0;
            text-align: center;
        }

        .top-nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding-top: 4px;
        }

        .tone-link {
            font-size: 14px;
            color: var(--accent);
            text-decoration: none;
        }

        .tone-link:hover {
            text-decoration: underline;
        }

        main#app {
            max-width: 960px;
            margin: 0 auto;
            padding: 12px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .view-header {
            display: flex;
            justify-content: center;
            padding: 8px 0 12px;
            position: sticky;
            top: 56px;
            background: var(--bg);
            z-index: 15;
            border-bottom: 1px solid var(--border);
        }

        .btn {
            border: 1px solid var(--border);
            background: var(--card);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color .12s ease, filter .12s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover {
            filter: brightness(.98)
        }

        .btn:active {
            background: var(--pressed);
        }

        .btn.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .btn.back {
            min-width: 140px;
            font-weight: 600;
        }

        .btn.ghost {
            background: transparent;
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: 12px;
        }

        .category-list li {
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 14px;
            padding: 16px;
            cursor: pointer;
            transition: filter .12s ease;
        }

        .category-list li:hover {
            filter: brightness(.98)
        }

        .category-list li:active {
            background: var(--pressed);
        }

        .category-name {
            display: block;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .category-count {
            color: var(--muted);
            font-size: 13px;
        }

        .category-title {
            text-align: center;
            margin: 14px 0;
            font-size: 18px;
        }

        .phrases-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .phrase-card {
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: 14px;
            padding: 12px;
        }

        .phrase-top {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .audio-btn {
            display: inline-block;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color .12s ease, filter .12s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .audio-btn:hover {
            filter: brightness(.98)
        }

        .audio-btn:active {
            background: var(--pressed);
        }

        .audio-btn.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .audio-btn[aria-busy="true"] {
            opacity: .7;
            pointer-events: none;
        }

        /* Colour feedback when a button is actively playing */
        .audio-btn.playing {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .syllable-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .syllable {
            border: 1px dashed var(--border);
            border-radius: 10px;
            padding: 8px;
            display: grid;
            grid-template-rows: auto auto auto;
            gap: 4px;
        }

        .syllable .syllable-text {
            font-size: 18px;
            font-weight: 700;
        }

        .syllable .tone-name {
            font-size: 12px;
            color: var(--muted);
        }

        .translation {
            margin-top: 8px;
            color: var(--muted);
            font-size: 14px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .note {
            color: var(--muted);
            font-size: 13px;
        }

        .app-footer {
            border-top: 1px solid var(--border);
            padding: 10px 12px 24px;
            margin-top: 18px;
            text-align: center;
            color: var(--muted);
            font-size: 12px;
        }

        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
            border: 0;
            padding: 0;
            margin: -1px;
        }

        @media (max-width:480px) {
            .syllable-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>

<body>
    <header class="app-header">
        <h1 class="app-title">John’s Vietnamese Phrases</h1>
        <nav class="top-nav">
            <a href="#tone-guide" id="toneGuideLink" class="tone-link">Tone Guide</a>
        </nav>
    </header>

    <main id="app">
        <!-- View: Categories (DEFAULT) -->
        <section id="view-categories" class="view active" aria-label="Categories">
            <h2 class="visually-hidden">Categories</h2>
            <ul id="categoryList" class="category-list"></ul>
        </section>

        <!-- View: Phrases -->
        <section id="view-phrases" class="view" aria-label="Phrases" hidden>
            <div class="view-header">
                <button id="btnBackToCategories" class="btn back">Categories</button>
            </div>
            <h2 id="phrasesCategoryTitle" class="category-title"></h2>
            <div id="phrasesContainer" class="phrases-container"></div>
        </section>

        <!-- View: Tone Guide -->
        <section id="view-tone" class="view" aria-label="Tone Guide" hidden>
            <div class="view-header">
                <button id="btnBackFromTone" class="btn back">Categories</button>
            </div>
            <h2 class="category-title">Tone Guide</h2>
            <div class="tone-guide">
                <ul>
                    <li><strong>sắc</strong> — rising ↗</li>
                    <li><strong>huyền</strong> — falling ↘</li>
                    <li><strong>hỏi</strong> — dipping ˇ</li>
                    <li><strong>nặng</strong> — heavy/low (glottal stop)</li>
                    <li><strong>không</strong> — level (no mark)</li>
                </ul>
                <p class="note">Micro-audio/visuals can be added later without changing layout.</p>
            </div>
        </section>
    </main>

    <footer class="app-footer">
        <small>Phase 1 — MVP (Syllable model, categories-first). Record/Compare &amp; Check Tone are
            placeholders.</small>
    </footer>

    <script>
        // =========================
        // ID-based mapping (no slugifying)
        // =========================

        /** Global mapping loaded from /assets/mapping.json */
        let MAPPING = null; // { categories:[{id,name}], phrases:{ [catId]: [{ id, vi, en, syllables:[{ id, text, tone }] }] } }

        async function initMapping() {
            try {
                const res = await fetch('/assets/mapping.json', { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                MAPPING = await res.json();
            } catch (err) {
                console.error('Failed to load mapping.json', err);
                MAPPING = { categories: [], phrases: {} };
            }
        }

        // Simple ID player — filenames are exact: assets/audio/<ID>.mp3
        // Adds colour feedback by toggling .playing on the clicked button while audio is playing.
        let CURRENT_AUDIO = null;
        let CURRENT_BTN = null;

        function playById(id, btn) {
            try {
                // Stop any previous audio and clear state
                if (CURRENT_AUDIO) {
                    CURRENT_AUDIO.pause();
                    CURRENT_AUDIO.currentTime = 0;
                }
                if (CURRENT_BTN) {
                    CURRENT_BTN.classList.remove('playing');
                    CURRENT_BTN.removeAttribute('aria-busy');
                }

                const audio = new Audio(`assets/audio/${id}.mp3`);
                CURRENT_AUDIO = audio;
                CURRENT_BTN = btn || null;

                if (CURRENT_BTN) {
                    CURRENT_BTN.classList.add('playing');
                    CURRENT_BTN.setAttribute('aria-busy', 'true');
                }

                audio.addEventListener('ended', () => {
                    if (CURRENT_BTN) {
                        CURRENT_BTN.classList.remove('playing');
                        CURRENT_BTN.removeAttribute('aria-busy');
                    }
                    CURRENT_AUDIO = null;
                    CURRENT_BTN = null;
                });

                audio.addEventListener('error', () => {
                    if (CURRENT_BTN) {
                        CURRENT_BTN.classList.remove('playing');
                        CURRENT_BTN.removeAttribute('aria-busy');
                    }
                    CURRENT_AUDIO = null;
                    CURRENT_BTN = null;
                });

                audio.play();
            } catch (e) {
                console.warn('Audio failed for id:', id, e);
            }
        }

        // =========================
        // Views / Rendering
        // =========================
        const $ = sel => document.querySelector(sel);

        function showView(name) {
            const views = ["categories", "phrases", "tone"];
            views.forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (!el) return;
                const on = v === name;
                el.hidden = !on;
                el.classList.toggle('active', on);
            });
            if (name === "categories") { window.scrollTo({ top: 0, behavior: 'instant' }); }
        }

        function renderCategories() {
            const ul = $("#categoryList");
            ul.innerHTML = "";
            (MAPPING.categories || []).forEach(cat => {
                const count = (MAPPING.phrases?.[cat.id] || []).length;
                const li = document.createElement('li');
                li.innerHTML = `<span class="category-name">${cat.name}</span>
                        <span class="category-count">${count} phrase${count === 1 ? "" : "s"}</span>`;
                li.addEventListener('click', () => openCategory(cat.id, cat.name));
                ul.appendChild(li);
            });
        }

        function openCategory(catId, catName) {
            $("#phrasesCategoryTitle").textContent = catName;
            const container = $("#phrasesContainer");
            container.innerHTML = "";

            const items = MAPPING.phrases?.[catId] || [];
            items.forEach(item => {
                // item: { id: '00001', vi, en, syllables:[{ id:'00037', text, tone }] }
                const card = document.createElement('div');
                card.className = 'phrase-card';

                // Top row: phrase play + text
                const top = document.createElement('div');
                top.className = 'phrase-top';

                const btnPhrase = document.createElement('button');
                btnPhrase.className = 'audio-btn primary';
                btnPhrase.textContent = "▶︎";
                btnPhrase.setAttribute('data-id', item.id);
                btnPhrase.addEventListener('click', () => playById(item.id, btnPhrase));

                const phraseText = document.createElement('div');
                phraseText.innerHTML = `<strong>${item.vi}</strong>`;

                top.appendChild(btnPhrase);
                top.appendChild(phraseText);

                // Syllables row
                const row = document.createElement('div');
                row.className = 'syllable-row';
                (item.syllables || []).forEach(syl => {
                    const wrap = document.createElement('div');
                    wrap.className = 'syllable';

                    const btnSyl = document.createElement('button');
                    btnSyl.className = 'audio-btn';
                    btnSyl.textContent = "▶︎";
                    btnSyl.setAttribute('data-id', syl.id);
                    btnSyl.addEventListener('click', () => playById(syl.id, btnSyl));

                    const sylText = document.createElement('div');
                    sylText.className = 'syllable-text';
                    sylText.textContent = syl.text;

                    const tone = document.createElement('div');
                    tone.className = 'tone-name';
                    tone.textContent = syl.tone;

                    wrap.appendChild(btnSyl);
                    wrap.appendChild(sylText);
                    wrap.appendChild(tone);
                    row.appendChild(wrap);
                });

                // Translation
                const tr = document.createElement('div');
                tr.className = 'translation';
                tr.textContent = item.en;

                // Controls: placeholders (unchanged)
                const controls = document.createElement('div');
                controls.className = 'controls';
                const btnRecord = document.createElement('button');
                btnRecord.className = 'btn';
                btnRecord.textContent = 'Record (placeholder)';
                btnRecord.title = 'Phase 1.5: temporary client-side recording';
                btnRecord.disabled = true;

                const btnMy = document.createElement('button');
                btnMy.className = 'btn';
                btnMy.textContent = 'Play My Recording';
                btnMy.title = 'Phase 1.5: toggle between app audio and user recording';
                btnMy.disabled = true;

                const btnCheck = document.createElement('button');
                btnCheck.className = 'btn';
                btnCheck.textContent = 'Check Tone';
                btnCheck.title = 'Placeholder for ToneChecker integration';
                btnCheck.disabled = true;

                controls.append(btnRecord, btnMy, btnCheck);

                // Assemble card
                card.appendChild(top);
                card.appendChild(row);
                card.appendChild(tr);
                card.appendChild(controls);

                container.appendChild(card);
            });

            showView('phrases');
        }

        // ——— Wiring: nav + init ———
        document.getElementById('toneGuideLink').addEventListener('click', (e) => { e.preventDefault(); showView('tone'); });
        document.getElementById('btnBackToCategories').addEventListener('click', () => showView('categories'));
        document.getElementById('btnBackFromTone').addEventListener('click', () => showView('categories'));

        // Boot
        (async function start() {
            await initMapping();
            renderCategories();
            showView('categories'); // categories-first
        })();
    </script>
</body>

</html>